<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://likfe.com</id>
    <title>Cafeting • Posts by &#34;jenkins&#34; tag</title>
    <link href="https://likfe.com" />
    <updated>2023-03-22T15:11:42.000Z</updated>
    <category term="Android" />
    <category term="Flurry" />
    <category term="Confluence" />
    <category term="反编译" />
    <category term="ReactNative" />
    <category term="AccessibilityNodeInfo" />
    <category term="StackOverflow" />
    <category term="Proxy" />
    <category term="AndroidStudio" />
    <category term="Translucent" />
    <category term="SwipeBack" />
    <category term="PopWindow" />
    <category term="AMH" />
    <category term="Flarum" />
    <category term="PHP" />
    <category term="Composer" />
    <category term="ViewPager" />
    <category term="ADB" />
    <category term="Clipboard" />
    <category term="framework" />
    <category term="gradle" />
    <category term="DialogFragment" />
    <category term="PopupWindow" />
    <category term="Google" />
    <category term="Glide" />
    <category term="Intent" />
    <category term="RecyclerView" />
    <category term="Lambda" />
    <category term="Leancloud" />
    <category term="Gradle" />
    <category term="Messenger" />
    <category term="Make" />
    <category term="Mac" />
    <category term="Linux" />
    <category term="JDK" />
    <category term="Fragment" />
    <category term="View" />
    <category term="Scrollbar" />
    <category term="备案" />
    <category term="域名" />
    <category term="Github" />
    <category term="GreenDao" />
    <category term="Rust" />
    <category term="IDEA" />
    <category term="GooglePlay" />
    <category term="Docker" />
    <category term="Jenkins" />
    <category term="MAMP" />
    <category term="树莓派" />
    <category term="Sublime Text" />
    <category term="Emmet" />
    <category term="ThinkPHP" />
    <category term="GitBook" />
    <category term="OSX" />
    <entry>
        <id>https://likfe.com/2023/03/22/jenkins-unable-to-produce-a-script-file/</id>
        <title>Jenkins 运行任务时遇到 FATAL Unable to produce a script file 报错（已解决）</title>
        <link rel="alternate" href="https://likfe.com/2023/03/22/jenkins-unable-to-produce-a-script-file/"/>
        <content type="html">&lt;p&gt;关键词：Jenkins、Unable to produce a script file、UnmappableCharacterException、IOException: Failed to create a temp file on&lt;/p&gt;
&lt;h2 id=&#34;0x00-问题描述&#34;&gt;&lt;a href=&#34;#0x00-问题描述&#34; class=&#34;headerlink&#34; title=&#34;0x00 问题描述&#34;&gt;&lt;/a&gt;0x00 问题描述&lt;/h2&gt;&lt;p&gt;由于使用的 Jenkins 存在安全漏洞（详见 &lt;a href=&#34;https://www.jenkins.io/security/advisory/2023-03-08/&#34;&gt;Jenkins Security Advisory 2023-03-08&lt;/a&gt;），需要升级到已解决安全漏洞的新版本，更新后运行任务时出现了报错：&lt;code&gt;FATAL: Unable to produce a script file&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;详细的报错日志如下：&lt;/p&gt;
&lt;span id=&#34;more&#34;&gt;&lt;/span&gt;

&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 拉取代码的 Commit 信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 Commit message: &lt;span class=&#34;string&#34;&gt;&amp;quot;feat: ????&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# 堆栈信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 FATAL: Unable to produce a script file&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 java.nio.charset.UnmappableCharacterException: Input length = 1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at java.base/java.nio.charset.CoderResult.throwException(CoderResult.java:275)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at java.base/sun.nio.cs.StreamEncoder.implWrite(StreamEncoder.java:306)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at java.base/sun.nio.cs.StreamEncoder.implWrite(StreamEncoder.java:281)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at java.base/sun.nio.cs.StreamEncoder.write(StreamEncoder.java:125)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at java.base/java.io.OutputStreamWriter.write(OutputStreamWriter.java:208)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at java.base/java.io.BufferedWriter.flushBuffer(BufferedWriter.java:120)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at java.base/java.io.BufferedWriter.close(BufferedWriter.java:268)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.FilePath&lt;span class=&#34;variable&#34;&gt;$CreateTextTempFile&lt;/span&gt;.invoke(FilePath.java:1658)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.FilePath&lt;span class=&#34;variable&#34;&gt;$CreateTextTempFile&lt;/span&gt;.invoke(FilePath.java:1628)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.FilePath.act(FilePath.java:1198)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.FilePath.act(FilePath.java:1181)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.FilePath.createTextTempFile(FilePath.java:1622)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 Caused: java.io.IOException: Failed to create a temp file on /var/jenkins_home/workspace/xxx&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.FilePath.createTextTempFile(FilePath.java:1624)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.tasks.CommandInterpreter.createScriptFile(CommandInterpreter.java:202)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.tasks.CommandInterpreter.perform(CommandInterpreter.java:120)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.tasks.CommandInterpreter.perform(CommandInterpreter.java:92)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.tasks.BuildStepMonitor&lt;span class=&#34;variable&#34;&gt;$1&lt;/span&gt;.perform(BuildStepMonitor.java:20)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.AbstractBuild&lt;span class=&#34;variable&#34;&gt;$AbstractBuildExecution&lt;/span&gt;.perform(AbstractBuild.java:818)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.Build&lt;span class=&#34;variable&#34;&gt;$BuildExecution&lt;/span&gt;.build(Build.java:199)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.Build&lt;span class=&#34;variable&#34;&gt;$BuildExecution&lt;/span&gt;.doRun(Build.java:164)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.AbstractBuild&lt;span class=&#34;variable&#34;&gt;$AbstractBuildExecution&lt;/span&gt;.run(AbstractBuild.java:526)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.Run.execute(Run.java:1900)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:44)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.ResourceController.execute(ResourceController.java:101)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 	at hudson.model.Executor.run(Executor.java:442)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16:21:35 Build step &lt;span class=&#34;string&#34;&gt;&amp;#x27;Execute shell&amp;#x27;&lt;/span&gt; marked build as failure&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&#34;0x01-定位原因&#34;&gt;&lt;a href=&#34;#0x01-定位原因&#34; class=&#34;headerlink&#34; title=&#34;0x01 定位原因&#34;&gt;&lt;/a&gt;0x01 定位原因&lt;/h2&gt;&lt;p&gt;根本原因隐藏在日志信息里：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;首先，可以看到 &lt;code&gt;Commit message: &amp;quot;feat: ????&amp;quot;&lt;/code&gt; 中的中文内容变成了乱码 &lt;code&gt;????&lt;/code&gt; 。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;从堆栈信息里 &lt;code&gt;java.nio.charset.UnmappableCharacterException: Input length = 1&lt;/code&gt; 可知，这是个和字符集相关的报错信息：&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;这个错误是由于Java运行时无法将一个输入的字符映射为所需要的字符集（通常是Unicode）而引起的。可能会发生这种情况：&lt;/p&gt;
&lt;p&gt;输入的文本包含了一个你使用的字符集无法映射的字符。&lt;br&gt;如果文本在不同的平台上被创建和传输，则可能会发生此错误，因为每个平台使用的默认字符集可能不同。&lt;br&gt;为了解决这个错误，你可以尝试以下方法：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;检查你的字符集: 在你的代码中，确保你所使用的字符集和输入文本的字符集匹配。&lt;/li&gt;
&lt;li&gt;检查文本: 检查输入文本中是否有在使用字符集时无法映射的字符或符号。&lt;/li&gt;
&lt;li&gt;指定字符集: 明确指定字符集，尤其是在不同平台之间传输文本时。最好使用标准字符集，例如UTF-8或ISO-8859-1等。&lt;br&gt;如果以上解决方法都无效，你可能需要查看代码以确定是否有其他问题。&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;0x02-解决方案&#34;&gt;&lt;a href=&#34;#0x02-解决方案&#34; class=&#34;headerlink&#34; title=&#34;0x02 解决方案&#34;&gt;&lt;/a&gt;0x02 解决方案&lt;/h2&gt;&lt;p&gt;既然是字符集（文件编码）相关的问题，解决方案有 2 个思路：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;去掉 Jenkins Job 里脚本和指令中的中文等字符&lt;/li&gt;
&lt;li&gt;让 Jenkins 的运行环境支持 UTF-8 编码，以正常处理和展示中文内容&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;方案一：移除无法正常处理和显示的中文内容&#34;&gt;&lt;a href=&#34;#方案一：移除无法正常处理和显示的中文内容&#34; class=&#34;headerlink&#34; title=&#34;方案一：移除无法正常处理和显示的中文内容&#34;&gt;&lt;/a&gt;方案一：移除无法正常处理和显示的中文内容&lt;/h3&gt;&lt;p&gt;进入 Jenkins Job 的配置中，定位报错的步骤卡到哪一个环节，查看脚本和指令是否使用了中文内容（注释也算）。&lt;/p&gt;
&lt;p&gt;在我的 Job 配置是 &lt;code&gt;Build Steps - 执行 shell&lt;/code&gt; 的 shell 脚本中，对指令做了中文注释，移除调中文内容，保存并重新执行一下 Job 的运行任务，发现可以正常完成构建任务了。&lt;/p&gt;
&lt;h3 id=&#34;方案二：让-Jenkins-支持中文&#34;&gt;&lt;a href=&#34;#方案二：让-Jenkins-支持中文&#34; class=&#34;headerlink&#34; title=&#34;方案二：让 Jenkins 支持中文&#34;&gt;&lt;/a&gt;方案二：让 Jenkins 支持中文&lt;/h3&gt;&lt;p&gt;让 Jenkins 正确处理和展示中文，有 2 个方法，可以根据自身情况进行设置：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;设置机器的 LANG&amp;#x3D;”C.UTF-8”&lt;/li&gt;
&lt;li&gt;ENKINS_JAVA_OPTS 或者 JAVA_OPTS 的值增加 &lt;code&gt;-Dfile.encoding=UTF8&lt;/code&gt; 的内容&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;这里推荐修改 LANG 的值来支持中文：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;由于我使用 Docker 方式安装的 Jenkins，所以只需要在创建 container 时设置 &lt;code&gt;-e LANG=&amp;quot;C.UTF-8&amp;quot;&lt;/code&gt; 即可；如何你使用 portainer 或者 Docker Compose，可自行查找设置、修改环境变量的方法。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;对于 ENKINS_JAVA_OPTS 或者 JAVA_OPTS 的值增加 &lt;code&gt;-Dfile.encoding=UTF8&lt;/code&gt; 的内容：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;注意一点，ENKINS_JAVA_OPTS 只影响 Jenkins 程序；JAVA_OPTS 则会影响所有本机器下所有基于 Java 运行的程序。&lt;br&gt;至于修改方式，参考上面修改 LANG 的过程。&lt;/p&gt;
&lt;p&gt;最后，对修改是否生效进行检查：&lt;/p&gt;
&lt;p&gt;设置完毕并重启 Jenkins 后，如果你是管理员，进入 &lt;code&gt;Dashboard-系统管理-系统信息-环境变量&lt;/code&gt; 查看下当前 Jenkins 的环境变量：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;检查 LANG 的值，查看下是否为 C.UTF-8 ；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;或者，查看 JENKINS_JAVA_OPTS 或者 JAVA_OPTS 的值里是否有 &lt;code&gt;-Dfile.encoding=UTF8&lt;/code&gt; ；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;最后，运行一下之前 Job 的构建任务，看看能否正常显示中文和正常完成构建。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;其他方案&#34;&gt;&lt;a href=&#34;#其他方案&#34; class=&#34;headerlink&#34; title=&#34;其他方案&#34;&gt;&lt;/a&gt;其他方案&lt;/h3&gt;&lt;p&gt;网上也有一些别的方案，如果报错信息中没有 &lt;code&gt;java.nio.charset.UnmappableCharacterException: Input length = 1&lt;/code&gt; 的信息，可能就不是编码问题。可以尝试：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;重启 Jenkins&lt;/li&gt;
&lt;li&gt;可能磁盘空间不足，可尝试删除 &lt;code&gt;/tmp/&lt;/code&gt; 缓存目录下的文件&lt;/li&gt;
&lt;li&gt;可能目录权限不正确，尝试把 Job 的 workspace 所在目录修改为 jenkins 能够读写的用户权限&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;0x03-总结&#34;&gt;&lt;a href=&#34;#0x03-总结&#34; class=&#34;headerlink&#34; title=&#34;0x03 总结&#34;&gt;&lt;/a&gt;0x03 总结&lt;/h2&gt;&lt;p&gt;定位问题的过程中，首先检索报错信息中的 Unable to produce a script file，有很多资料都没有说明为什么要使用文章里的解决方案，仅仅是做个记录，没有深入追溯原因，走了不少弯路。&lt;/p&gt;
&lt;p&gt;之后，结合 Commit 信息乱码，检索报错信息中的 java.nio.charset.UnmappableCharacterException: Input length &amp;#x3D; 1，终于找到核心原因：文件编码问题。之后一路查官方文档等，找到了合适的解决方案。&lt;/p&gt;
&lt;p&gt;资料：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Jenkins 的 &lt;a href=&#34;https://github.com/jenkinsci/docker/blob/master/README.md&#34;&gt;Docker 安装文档&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.jenkins.io/doc/book/installing/&#34;&gt;Jenkins 安装文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果有什么建议或者问题可以随时联系我，共同探讨学习：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Github： &lt;a href=&#34;https://github.com/likfe&#34;&gt;likfe&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;CSDN：&lt;a href=&#34;https://micro.blog.csdn.net/&#34;&gt;他叫自己Mr.张&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;掘金：&lt;a href=&#34;https://juejin.im/user/56042f4b60b2f3a91f58461d&#34;&gt;cafeting&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;微博：&lt;a href=&#34;http://weibo.com/zyansen&#34;&gt;cafeting&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
</content>
        <category term="Docker" />
        <category term="Jenkins" />
        <updated>2023-03-22T15:11:42.000Z</updated>
    </entry>

    <follow_challenge>
        <feedId>73986782175755264</feedId>
        <userId>72100854660436992</userId>
    </follow_challenge>
</feed>
